# 更新日志

## v3.0.2 (2025-09-18)

### 🚀 FPM 环境优化

#### 持久化缓存机制
- **智能缓存**：合并后的数据库文件缓存到系统临时目录
- **自动验证**：基于文件大小、修改时间和内容格式验证缓存有效性
- **自动恢复**：进程重启后自动检测并使用有效缓存文件
- **避免重复**：相同分片文件不会重复合并，提升性能

#### 缓存验证策略
- **文件大小检查**：IPv4 最小 10MB，IPv6 最小 100MB
- **时间戳对比**：检查缓存文件是否比源分片文件更新
- **内容格式验证**：验证文件包含地理位置数据标识符
- **自动更新**：分片文件更新时自动重新生成缓存

#### 性能优势
- **首次加载**：IPv4 约 32ms，IPv6 约 1175ms
- **缓存命中**：IPv4 约 0.5ms，IPv6 约 1ms
- **性能提升**：IPv4 提升 98.4%，IPv6 提升 99.9%

### 📊 性能测试增强

#### 系统信息展示
- **硬件信息**：CPU 型号、核心数、内存配置
- **系统环境**：操作系统、PHP 版本、磁盘空间
- **性能指标**：内存使用、系统负载、执行时间

#### 性能评分系统
- **评分机制**：基于查询速度、批量处理、循环性能综合评分
- **等级评定**：优秀 ⭐⭐⭐⭐⭐、良好 ⭐⭐⭐⭐、中等 ⭐⭐⭐
- **方法调用说明**：详细展示每个测试调用的具体方法

#### 测试内容
- 首次加载测试（无缓存）
- 缓存命中测试
- 查询方法性能对比
- 批量查询测试（10个IP + 10000个IP）
- 循环查询测试（10000次）
- 内存使用测试
- 缓存清理性能测试

### 📚 文档完善

#### 数据库优先级说明
- **优先级机制**：自定义数据库 > 持久化缓存 > 分片文件合并
- **性能对比表**：详细对比不同模式的性能特点
- **使用建议**：针对不同环境的配置建议

#### 自定义数据库配置
- **配置指南**：详细的自定义数据库配置说明
- **路径建议**：推荐的文件存放位置和权限设置
- **下载指南**：免费和商业版本的获取方式

#### 项目结构优化
- **目录说明**：明确各目录的用途和内容
- **工具分类**：区分用户使用和开发工具
- **文档组织**：将详细文档移至 `doc/` 目录

### 🛠️ 技术改进

#### 代码优化
- **路径修正**：修正分片文件路径从 `tools/` 到 `db/`
- **错误处理**：改进自定义数据库文件的错误处理
- **兼容性**：确保 PHP 5.4+ 完全兼容

#### API 增强
- **缓存管理**：`clearPersistentCache()` 方法
- **性能监控**：增强的性能统计和监控功能
- **方法说明**：详细的 API 调用说明

### 📈 性能指标

#### 测试环境
- **硬件**：Apple M4 Pro (14核心)，16GB+ 内存
- **系统**：macOS 15.0 (Darwin 25.0.0)
- **PHP**：8.1.29

#### 性能数据
- **QPS 性能**：10000个IP 达到 99256 QPS
- **循环查询**：10000次循环达到 181061 QPS
- **内存使用**：当前 4MB，峰值 76.55MB
- **性能评分**：90/100 (优秀 ⭐⭐⭐⭐⭐)

## v3.0.1 (2025-09-16)

### 🔧 自定义数据库配置

#### 新增功能

-   **自定义数据库路径**：支持指定自定义的 IPv4 和 IPv6 数据库文件路径
-   **混合模式支持**：IPv4 和 IPv6 可以独立配置使用自定义或默认分片数据库
-   **动态配置管理**：支持运行时动态设置和修改数据库路径
-   **自动回退机制**：自定义文件不存在时自动回退到默认分片模式
-   **配置状态检查**：提供方法检查当前使用的数据库配置状态

#### API 增强

-   **构造函数增强**：`new Ip2Region($cachePolicy, $dbPathV4, $dbPathV6)`
-   **动态设置方法**：`setCustomDbPaths($v4Path, $v6Path)`
-   **状态检查方法**：`isUsingCustomDb()`
-   **配置信息方法**：`getCustomDbInfo()`
-   **数据库信息增强**：`getDatabaseInfo()` 包含自定义路径信息

#### 兼容性改进

-   **PHP 5.4+ 兼容**：修复 `?:` 操作符兼容性问题，确保完全兼容 PHP 5.4+
-   **向后兼容**：现有代码无需修改，默认使用分片数据库模式
-   **语法优化**：替换不兼容的语法结构，提升代码稳定性

#### 使用示例

```php
// 默认模式（分片数据库）
$searcher = new Ip2Region();

// 自定义模式
$searcher = new Ip2Region('file', '/path/to/v4.xdb', '/path/to/v6.xdb');

// 混合模式
$searcher = new Ip2Region('file', '/path/to/v4.xdb', null); // IPv4 自定义，IPv6 默认

// 动态设置
$searcher->setCustomDbPaths('/path/to/v4.xdb', '/path/to/v6.xdb');

// 检查状态
$status = $searcher->isUsingCustomDb();
echo "IPv4 使用自定义: " . ($status['v4'] ? '是' : '否') . "\n";
```

### 🛠️ 技术改进

-   **代码质量**：修复所有 PHP 5.4+ 兼容性问题
-   **错误处理**：增强自定义数据库文件的错误处理机制
-   **文档完善**：更新所有相关文档，包含自定义数据库配置说明
-   **测试覆盖**：添加自定义数据库配置的完整测试用例
-   **链接修正**：更正官网地址为 https://www.ip2region.net/

## v3.0.0 (2025-09-15)

### 🚀 重大更新

#### 新增功能

-   **智能分片系统**：支持大型数据库文件自动分片，优化内存使用
-   **多格式压缩支持**：支持 gzip、zip、zstd 多种压缩格式
-   **智能压缩算法**：压缩率高达 81%，大幅减少存储空间
-   **分片数据库助手**：自动合并分片文件，支持缓存机制
-   **快速模式**：跳过压缩以提升分片速度
-   **智能分片算法**：动态调整分片大小，确保分片均匀分布

#### 性能优化

-   **内存优化**：使用分块写入避免大文件内存溢出
-   **缓存优化**：智能缓存机制，避免重复合并
-   **查询优化**：支持 IPv4 和 IPv6 双协议查询
-   **加载优化**：懒加载机制，按需创建查询器

#### 技术改进

-   **错误处理**：完善的错误处理和异常管理
-   **文件管理**：支持多种数据库格式和版本检测
-   **代码质量**：完整的 PHPDoc 注释和文档
-   **兼容性**：兼容 PHP 5.4+，零依赖

### 📊 压缩效果

| 数据库版本 | 原始大小 | 压缩后大小 | 压缩率 | 分片数量 |
| ---------- | -------- | ---------- | ------ | -------- |
| IPv4       | 10.5MB   | 4.1MB      | 61%    | 1 个     |
| IPv6       | 617.1MB  | 115.6MB    | 81.3%  | 21 个    |

### 🛠️ 工具更新

#### 分片工具 (tools/split_db.php)

-   支持多种压缩格式
-   智能分片大小调整
-   快速模式选项
-   详细的进度显示

#### 合并助手 (src/ChunkedDbHelper.php)

-   自动分片文件查找
-   智能版本检测
-   内存优化处理
-   缓存管理机制

### 📚 文档更新

-   **完整注释**：所有 PHP 文件添加了详细的 PHPDoc 注释
-   **使用示例**：提供了丰富的使用示例和最佳实践
-   **API 文档**：完整的 API 参考文档
-   **README 更新**：详细的功能说明和使用指南

### 🔧 配置更新

#### Composer 配置

-   更新项目描述和关键词
-   添加快速模式脚本
-   优化自动加载配置

#### 项目结构

```
ip2region/
├── src/                    # 核心源码
│   ├── Ip2Region.php      # 主类，支持IPv4/IPv6双协议
│   ├── XdbSearcher.php    # XDB搜索引擎
│   └── ChunkedDbHelper.php # 分片数据库助手
├── tools/                  # 工具脚本
│   ├── split_db.php       # 数据库分片工具
│   ├── ip2region_v4.xdb   # IPv4数据库
│   └── ip2region_v6.xdb   # IPv6数据库
├── tests/                  # 测试文件
│   └── demo.php           # 演示脚本
├── db/                     # 分片数据库存储
└── vendor/                 # Composer依赖
```

### 🎯 使用建议

#### 推荐配置

```bash
# 标准压缩模式（推荐）
php tools/split_db.php v6 50 gzip

# 快速模式（无压缩）
php tools/split_db.php v6 100 gzip fast

# 最大压缩（分片较多）
php tools/split_db.php v6 30 gzip
```

#### Composer 脚本

```bash
# 运行演示
composer demo

# 测试IPv4查询
composer test:ipv4

# 测试IPv6查询
composer test:ipv6

# 分片IPv6数据库
composer split:v6

# 快速分片模式
composer split:v6:fast
```

### 🐛 修复问题

-   修复分片合并时的大小计算错误
-   修复重复分片文件问题
-   修复内存溢出问题
-   修复 IPv4 和 IPv6 数据库识别问题

### 📈 性能提升

-   **查询速度**：毫秒级响应时间
-   **内存使用**：优化后内存使用稳定
-   **存储空间**：压缩后减少 81%存储空间
-   **加载速度**：分片加载大幅提升启动速度
